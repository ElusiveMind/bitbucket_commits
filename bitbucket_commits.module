<?php

/**
 * Implements hook_menu().
 */
function bitbucket_commits_menu() {
  $items = array();
  $items['admin/config/development/bitbucket'] = array(
    'title' => 'Bitbucket Settings',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('bitbucket_commits_api_settings_form'),
    'access callback' => 'user_access',
    'access arguments' => array('access bitbucket settings'),
  );
  $items['admin/config/development/bitbucket/api'] = array(
    'title' => 'Bitbucket API Settings',
    'description' => t('Settings for accessing BitBucket API as well as repositories to pull data from.'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('bitbucket_commits_api_settings_form'),
    'access callback' => 'user_access',
    'access arguments' => array('access bitbucket settings'),
    'weight' => 1,
  );
  $items['admin/config/development/bitbucket/github-api'] = array(
    'title' => 'GitHub API Settings',
    'description' => t('Settings for accessing GitHub API as well as repositories to pull data from.'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('bitbucket_commits_github_api_settings_form'),
    'access callback' => 'user_access',
    'access arguments' => array('access bitbucket settings'),
    'weight' => 1,
  );
  $items['admin/config/development/bitbucket/display'] = array(
    'title' => 'Display Settings',
    'description' => t('Configure colors and display configuration settings for statistic graphs.'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('bitbucket_commits_display_settings_form'),
    'access callback' => 'user_access',
    'access arguments' => array('access bitbucket settings'),
    'weight' => 2,
  );
  $items['admin/config/development/bitbucket/sync-bitbucket'] = array(
    'title' => 'Bitbucket Sync',
    'page callback' => 'bitbucket_commits_bitbucket_sync',
    'access callback' => 'user_access',
    'access arguments' => array('access bitbucket settings'),
    'weight' => 3,
  );
  $items['admin/config/development/bitbucket/sync-github'] = array(
    'title' => 'GitHub Sync',
    'page callback' => 'bitbucket_commits_github_sync',
    'access callback' => 'user_access',
    'access arguments' => array('access bitbucket settings'),
    'weight' => 4,
  );
  $items['admin/config/development/bitbucket/clear'] = array(
    'title' => 'Clear',
    'page callback' => 'bitbucket_commits_clear',
    'access callback' => 'user_access',
    'access arguments' => array('access bitbucket settings'),
    'weight' => 5,
  );
  return $items;
}

/**
 * Implements hook_permission().
 */
function bitbucket_commits_permission() {
  return array(
    'access bitbucket settings' => array(
      'title' => 'Settings',
    ),
  );
}

/**
 * Bitbucket API settings callback form.
 */
function bitbucket_commits_api_settings_form($form, &$form_state) {
  $form['bitbucket_username'] = array(
    '#title' => 'Bitbucket Username',
    '#description' => t('The username for the configured Bitbucket account.'),
    '#type' => 'textfield',
    '#size' => 64,
    '#maxlength' => 64,
    '#default_value' => variable_get('bitbucket_username', NULL),
  );
  $form['bitbucket_password'] = array(
    '#title' => 'Bitbucket Password',
    '#description' => t('The password for the configured Bitbucket account. Will not appear if already assigned. Only needs to be provided if not provided before or if the password has changed.'),
    '#type' => 'textfield',
    '#size' => 64,
    '#maxlength' => 64,
  );
  $form['bitbucket_repositories'] = array(
    '#title' => 'Bitbucket Repositories',
    '#description' => t('One repository per line. Prefix with username/reponame'),
    '#type' => 'textarea',
    '#default_value' => variable_get('bitbucket_repositories', NULL),
  );
  $form['bitbucket_repositories_line_numbers'] = array(
    '#title' => 'Bitbucket Repositories For Line Number Statistics',
    '#description' => t('One repository per line. Prefix with username/reponame. These are the repositories to track the number of line changes.'),
    '#type' => 'textarea',
    '#default_value' => variable_get('bitbucket_repositories_line_numbers', NULL),
  );
  $form['bitbucket_do_not_display'] = array(
    '#title' => 'Omit These Bitbucket Repositories From The List',
    '#description' => t('Repositories listed here will not be included in the details of number of commits in the last two weeks.'),
    '#type' => 'textarea',
    '#default_value' => variable_get('bitbucket_do_not_display', NULL),
  );
  $form['bitbucket_raw_names'] = array(
    '#title' => 'Other Possible Commit Names',
    '#description' => t('Other names a commit may be logged under aside from your username. Used to assign commits to your statistics. One per line. This can also be a partial name. Will be matched by substring.'),
    '#type' => 'textarea',
    '#default_value' => variable_get('bitbucket_raw_names', NULL),
  );
  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => 'Submit',
  );
  return $form;
}

/**
 * Submit callback for our API settings form. Handles password input so that if the password
 * field is empty and a password is already assigned, then it maintains the previously given
 * password. Also processes other api configuration values.
 */
function bitbucket_commits_api_settings_form_submit($form, &$form_state) {
  $current_password = variable_get('bitbucket_password', NULL);
  if ((!empty($current_password) && !empty($form_state['values']['bitbucket_password'])) || (empty($current_password))) {
    variable_set('bitbucket_password', $form_state['values']['bitbucket_password']);
  }

  $current_password = variable_get('bitbucket_password', NULL);
  if (!$current_password) {
    form_set_error('bitbucket_password', 'You must provide a password for this bitbucket account.');
  }
  else {
    variable_set('bitbucket_username', $form_state['values']['bitbucket_username']);
    variable_set('bitbucket_repositories', $form_state['values']['bitbucket_repositories']);
    variable_set('bitbucket_repositories_line_numbers', $form_state['values']['bitbucket_repositories_line_numbers']);
    variable_set('bitbucket_username', $form_state['values']['bitbucket_username']);
    variable_set('bitbucket_raw_names', $form_state['values']['bitbucket_raw_names']);
    variable_set('bitbucket_do_not_display', $form_state['values']['bitbucket_do_not_display']);
    drupal_set_message('Bitbucket API settings successfully updated.', 'status');
    drupal_goto('admin/config/development/bitbucket/api');
  }
}

/**
 * GitHub API settings callback formm
 */
function bitbucket_commits_github_api_settings_form($form, &$form_state) {
  $form['bitbucket_github_username'] = array(
    '#title' => 'GitHub Username',
    '#description' => t('The username for the configured GitHub account.'),
    '#type' => 'textfield',
    '#size' => 64,
    '#maxlength' => 64,
    '#default_value' => variable_get('bitbucket_github_username', NULL),
  );
   $form['bitbucket_github_personal_access_token'] = array(
    '#title' => 'GitHub Personal Access Token',
    '#description' => t('The personal access token you generated on the GitHub site.'),
    '#type' => 'textfield',
    '#size' => 64,
    '#maxlength' => 64,
    '#default_value' => variable_get('bitbucket_github_personal_access_token', NULL),
  );
  $form['bitbucket_github_repositories'] = array(
    '#title' => 'GitHub Repositories',
    '#description' => t('One repository per line. Prefix with username/reponame'),
    '#type' => 'textarea',
    '#default_value' => variable_get('bitbucket_github_repositories', NULL),
  );
  $form['bitbucket_github_repositories_line_numbers'] = array(
    '#title' => 'GitHub Repositories For Line Number Statistics',
    '#description' => t('One repository per line. Prefix with username/reponame. These are the repositories to track the number of line changes.'),
    '#type' => 'textarea',
    '#default_value' => variable_get('bitbucket_github_repositories_line_numbers', NULL),
  );
  $form['bitbucket_github_do_not_display'] = array(
    '#title' => 'Omit These GitHub Repositories From The List',
    '#description' => t('Repositories listed here will not be included in the details of number of commits in the last two weeks.'),
    '#type' => 'textarea',
    '#default_value' => variable_get('bitbucket_github_do_not_display', NULL),
  );
  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => 'Submit',
  );
  return $form;
}

/**
 * Submit callback for our API settings form. Processes GitHub api configuration values.
 */
function bitbucket_commits_github_api_settings_form_submit($form, &$form_state) {
  variable_set('bitbucket_github_personal_access_token', $form_state['values']['bitbucket_github_personal_access_token']);
  variable_set('bitbucket_github_repositories', $form_state['values']['bitbucket_github_repositories']);
  variable_set('bitbucket_github_repositories_line_numbers', $form_state['values']['bitbucket_github_repositories_line_numbers']);
  variable_set('bitbucket_github_username', $form_state['values']['bitbucket_github_username']);
  variable_set('bitbucket_github_do_not_display', $form_state['values']['bitbucket_github_do_not_display']);
  drupal_set_message('GitHub API settings successfully updated.', 'status');
  drupal_goto('admin/config/development/bitbucket/github-api');
}

/**
 * Display settings administrative form.
 */
function bitbucket_commits_display_settings_form($form, &$form_state) {
  $form['bitbucket_activity_color_current'] = array(
    '#type' => 'markup',
    '#markup' => theme('bitbucket_commits_activity_graph'),
  );

  $form['bitbucket'] = array(
    '#type' => 'fieldset',
    '#title' => 'Bitbucket Settings',
  );
  $form['github'] = array(
    '#type' => 'fieldset',
    '#title' => 'GitHub Settings',
  );
  $form['bitbucket']['bitbucket_activity_color_scheme'] = array(
    '#type' => 'select',
    '#title' => 'Bitbucket Color Scheme',
    '#description' => 'Select a color scheme for the contribution activity graph. If using different ones for Bitbucket and GitHub, commits on tbe same day will show a color mixing of the two.',
    '#options' => array(
      'grey' => t('Grey'),
      'red' => t('Red'),
      'green' => t('Green'),
      'blue' => t('Blue'),
      'yellow' => t('Yellow'),
      'orange' => t('Orange'),
      'brown' => t('Brown'),
      'purple' => t('Purple'),
      'pink' => t('Pink'),
      'github' => t('GitHub'),
      'custom' => t('Custom (must provide hex values)'),
    ),
    '#default_value' => variable_get('bitbucket_activity_color_scheme', 'github'),
    '#required' => TRUE,
  );  
  $form['bitbucket']['bitbucket_activity_custom_color1'] = array(
    '#type' => 'textfield',
    '#title' => 'Custom Color 1',
    '#description' => t('The full hex color for the lighest color indicating no activity.'),
    '#default_value' => variable_get('bitbucket_activity_custom_color1', '#EEEEEE'),
    '#maxlength' => 7,
    '#size' => 7,
    '#states' => array(
      'visible' => array('select[name="bitbucket_activity_color_scheme"]' => array('value' => 'custom')),
    ),
  );
  $form['bitbucket']['bitbucket_activity_custom_color2'] = array(
    '#type' => 'textfield',
    '#title' => 'Custom Color 2',
    '#description' => t('The full hex color for a light color indicating light activity.'),
    '#default_value' => variable_get('bitbucket_activity_custom_color2', '#A0A0A0'),
    '#maxlength' => 7,
    '#size' => 7,
    '#states' => array(
      'visible' => array('select[name="bitbucket_activity_color_scheme"]' => array('value' => 'custom')),
    ),
  );
  $form['bitbucket']['bitbucket_activity_custom_color3'] = array(
    '#type' => 'textfield',
    '#title' => 'Custom Color 3',
    '#description' => t('The full hex color for a light color indicating medium activity.'),
    '#default_value' => variable_get('bitbucket_activity_custom_color3', '#606060'),
    '#maxlength' => 7,
    '#size' => 7,
    '#states' => array(
      'visible' => array('select[name="bitbucket_activity_color_scheme"]' => array('value' => 'custom')),
    ),
  );
  $form['bitbucket']['bitbucket_activity_custom_color4'] = array(
    '#type' => 'textfield',
    '#title' => 'Custom Color 4',
    '#description' => t('The full hex color for a dark color indicating moderate-heavy activity.'),
    '#default_value' => variable_get('bitbucket_activity_custom_color4', '#202020'),
    '#maxlength' => 7,
    '#size' => 7,
    '#states' => array(
      'visible' => array('select[name="bitbucket_activity_color_scheme"]' => array('value' => 'custom')),
    ),
  );
  $form['bitbucket']['bitbucket_activity_custom_color5'] = array(
    '#type' => 'textfield',
    '#title' => 'Custom Color 5',
    '#description' => t('The full hex color for the darkest color indicating heavy activity.'),
    '#default_value' => variable_get('bitbucket_activity_custom_color5', '#000000'),
    '#maxlength' => 7,
    '#size' => 7,
    '#states' => array(
      'visible' => array('select[name="bitbucket_activity_color_scheme"]' => array('value' => 'custom')),
    ),
  );

$form['github']['bitbucket_github_activity_color_scheme'] = array(
    '#type' => 'select',
    '#title' => 'GitHub Color Scheme',
    '#description' => 'Select a color scheme for the contribution activity graph. If using different ones for Bitbucket and GitHub, commits on tbe same day will show a color mixing of the two.',
    '#options' => array(
      'grey' => t('Grey'),
      'red' => t('Red'),
      'green' => t('Green'),
      'blue' => t('Blue'),
      'yellow' => t('Yellow'),
      'orange' => t('Orange'),
      'brown' => t('Brown'),
      'purple' => t('Purple'),
      'pink' => t('Pink'),
      'github' => t('GitHub'),
      'custom' => t('Custom (must provide hex values)'),
    ),
    '#default_value' => variable_get('bitbucket_github_activity_color_scheme', 'github'),
    '#required' => TRUE,
  );  
  $form['github']['bitbucket_github_activity_custom_color1'] = array(
    '#type' => 'textfield',
    '#title' => 'Custom Color 1',
    '#description' => t('The full hex color for the lighest color indicating no activity.'),
    '#default_value' => variable_get('bitbucket_github_activity_custom_color1', '#EEEEEE'),
    '#maxlength' => 7,
    '#size' => 7,
    '#states' => array(
      'visible' => array('select[name="bitbucket_github_activity_color_scheme"]' => array('value' => 'custom')),
    ),
  );
  $form['github']['bitbucket_github_activity_custom_color2'] = array(
    '#type' => 'textfield',
    '#title' => 'Custom Color 2',
    '#description' => t('The full hex color for a light color indicating light activity.'),
    '#default_value' => variable_get('bitbucket_github_activity_custom_color2', '#A0A0A0'),
    '#maxlength' => 7,
    '#size' => 7,
    '#states' => array(
      'visible' => array('select[name="bitbucket_github_activity_color_scheme"]' => array('value' => 'custom')),
    ),
  );
  $form['github']['bitbucket_github_activity_custom_color3'] = array(
    '#type' => 'textfield',
    '#title' => 'Custom Color 3',
    '#description' => t('The full hex color for a light color indicating medium activity.'),
    '#default_value' => variable_get('bitbucket_github_activity_custom_color3', '#606060'),
    '#maxlength' => 7,
    '#size' => 7,
    '#states' => array(
      'visible' => array('select[name="bitbucket_github_activity_color_scheme"]' => array('value' => 'custom')),
    ),
  );
  $form['github']['bitbucket_github_activity_custom_color4'] = array(
    '#type' => 'textfield',
    '#title' => 'Custom Color 4',
    '#description' => t('The full hex color for a dark color indicating moderate-heavy activity.'),
    '#default_value' => variable_get('bitbucket_github_activity_custom_color4', '#202020'),
    '#maxlength' => 7,
    '#size' => 7,
    '#states' => array(
      'visible' => array('select[name="bitbucket_github_activity_color_scheme"]' => array('value' => 'custom')),
    ),
  );
  $form['github']['bitbucket_github_activity_custom_color5'] = array(
    '#type' => 'textfield',
    '#title' => 'Custom Color 5',
    '#description' => t('The full hex color for the darkest color indicating heavy activity.'),
    '#default_value' => variable_get('bitbucket_github_activity_custom_color5', '#000000'),
    '#maxlength' => 7,
    '#size' => 7,
    '#states' => array(
      'visible' => array('select[name="bitbucket_github_activity_color_scheme"]' => array('value' => 'custom')),
    ),
  );
  
  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => 'Submit',
  );
  return $form;
}

/**
 * Submit callback for the displays administrative form.
 */
function bitbucket_commits_display_settings_form_submit($form, &$form_state) {
  // If the color scheme for bitbucket is set to custom, then we must have hex values for 
  // each of the custom color fields.
  if ($form_state['values']['bitbucket_activity_color_scheme'] == 'custom') {
    $color1 = $form_state['values']['bitbucket_activity_custom_color1'];
    $color2 = $form_state['values']['bitbucket_activity_custom_color2'];
    $color3 = $form_state['values']['bitbucket_activity_custom_color3'];
    $color4 = $form_state['values']['bitbucket_activity_custom_color4'];
    $color5 = $form_state['values']['bitbucket_activity_custom_color5'];
    for($i = 1; $i <= 4; $i++) {
      $var = "color" . $i;
      if (empty($$var)) {
        form_set_error($$var, 'You must provide a hex color (complete with the #) for Custom Bitbucket Color ' . $i);
      }
    }
  }

  // If the color scheme for github is set to custom, then we must have hex values for 
  // each of the custom color fields.
  if ($form_state['values']['bitbucket_github_activity_color_scheme'] == 'custom') {
    $color1 = $form_state['values']['bitbucket_github_activity_custom_color1'];
    $color2 = $form_state['values']['bitbucket_github_activity_custom_color2'];
    $color3 = $form_state['values']['bitbucket_github_activity_custom_color3'];
    $color4 = $form_state['values']['bitbucket_github_activity_custom_color4'];
    $color5 = $form_state['values']['bitbucket_github_activity_custom_color5'];
    for($i = 1; $i <= 4; $i++) {
      $var = "color" . $i;
      if (empty($$var)) {
        form_set_error($$var, 'You must provide a hex color (complete with the #) for Custom GitHub Color ' . $i);
      }
    }
  }

  variable_set('bitbucket_activity_color_scheme', $form_state['values']['bitbucket_activity_color_scheme']);
  variable_set('bitbucket_activity_custom_color1', $form_state['values']['bitbucket_activity_custom_color1']);
  variable_set('bitbucket_activity_custom_color2', $form_state['values']['bitbucket_activity_custom_color2']);
  variable_set('bitbucket_activity_custom_color3', $form_state['values']['bitbucket_activity_custom_color3']);
  variable_set('bitbucket_activity_custom_color4', $form_state['values']['bitbucket_activity_custom_color4']);
  variable_set('bitbucket_activity_custom_color5', $form_state['values']['bitbucket_activity_custom_color5']);

  variable_set('bitbucket_github_activity_color_scheme', $form_state['values']['bitbucket_github_activity_color_scheme']);
  variable_set('bitbucket_github_activity_custom_color1', $form_state['values']['bitbucket_github_activity_custom_color1']);
  variable_set('bitbucket_github_activity_custom_color2', $form_state['values']['bitbucket_github_activity_custom_color2']);
  variable_set('bitbucket_github_activity_custom_color3', $form_state['values']['bitbucket_github_activity_custom_color3']);
  variable_set('bitbucket_github_activity_custom_color4', $form_state['values']['bitbucket_github_activity_custom_color4']);
  variable_set('bitbucket_github_activity_custom_color5', $form_state['values']['bitbucket_github_activity_custom_color5']);

  drupal_set_message('Bitbucket/GitHub display settings successfully updated.', 'status');
  drupal_goto('admin/config/development/bitbucket/display');    
}

/**
 * Synchronize our Bitbucket repository configuration with the site.
 */
function bitbucket_commits_bitbucket_sync() {
  set_time_limit(0);
  _bitbucket_commits_retrieve();
  drupal_set_message('Bitbucket Synchronization completed.', 'status');
  drupal_goto('admin/config/development/bitbucket/display');
}

/**
 * Synchronize our GitHub repository configuration with the site. 
 */
function bitbucket_commits_github_sync() {
  set_time_limit(0);
  _bitbucket_commits_github_retrieve();
  drupal_set_message('GitHub Synchronization completed.', 'status');
  drupal_goto('admin/config/development/bitbucket/display');
}

/**
 * Crons need to be implemented via Elysia Cron. Or at least this is the current working theory
 * as to why crons do not run properly. This is the function to tun the bitbucket import job as
 * a cron with Elysia Cron.
 */
function bitbucket_commits_bitbucket_cron() {
  set_time_limit(0);
  _bitbucket_commits_retrieve();
}

/**
 * Crons need to be implemented via Elysia Cron. Or at least this is the current working theory
 * as to why crons do not run properly. This is the function to tun the github import job as
 * a cron with Elysia Cron.
 */
function bitbucket_commits_github_cron() {
  set_time_limit(0);
  _bitbucket_commits_github_retrieve();
}

/**
 * Retrieve all of the commits configured from bitbucket.
 */
function _bitbucket_commits_retrieve() {
  $repos = variable_get('bitbucket_repositories', FALSE);
  $repos_line = variable_get('bitbucket_repositories_line_numbers', FALSE);
  $username = variable_get('bitbucket_username', NULL);
  $password = variable_get('bitbucket_password', NULL);
  $raw_usernames = variable_get('bitbucket_raw_names', NULL);
  $raw_usernames = explode("\n", $raw_usernames);

  if (!empty($repos_line)) {
    $repos_line = explode("\n", $repos_line);
  }

  if (empty($repos)) {
    return FALSE;
  }

  $repos = explode("\n", $repos);
  $repositories = array();
  foreach($repos as $repo) {
    if (empty($repo)) {
      continue;
    }
    $repo = trim($repo);
    $url = 'https://api.bitbucket.org/2.0/repositories/' . $repo . '/commits?pagelen=100';
    do {
      $json = _bitbucket_commits_api_call($url, $username, $password, FALSE);
      if ($json == FALSE) {
        drupal_set_message('Bitbucket API rate limit exceeded. Repository: ' . $repo, 'error');
        db_query('DELETE FROM {commits} WHERE project = :project', array(':project' => $repo));
        drupal_goto('admin/config/development/bitbucket/display');
      }
      if (empty($json->values)) {
        drupal_set_message('No repository named ' . $repo . '.', 'error');
        break;
      }
      if (count($json->values) > 0) {
        foreach ($json->values as $commit) {
          if (!array_key_exists($commit->repository->full_name, $repositories)) {
            $repository_information = bitbucket_commits_get_repository_information($repo, $username, $password);
            $repositories[$commit->repository->full_name] = $repository_information;
          };

          $cid = $commit->hash;
          $project = $commit->repository->full_name;
          $message = $commit->message;

          // Do timezone conversion of the date from BitBucket. All their times are in
          // UTC regardles of your timezone settings. Adjust this to Drupal's default
          // timezone for storage. Doing so here, enables our other time-sensitive
          // queries to work properly.
          $commit->date = new DateTime($commit->date, new DateTimeZone('UTC'));
          $commit->date->setTimezone(new DateTimeZone('America/New_York'));
          $the_date = (array) $commit->date;
          $the_date['commit_date'] = (array) $commit->date->date;
          list($commit_date, $commit_time) = explode(' ', $the_date['date']);
          list($commit_time) = explode('.', $commit_time);
          $commit->date = $commit_date . ' ' . $commit_time;

          $pass = FALSE;
          if (!empty($commit->author)) {
            if (!empty($commit->author->user->username) && $commit->author->user->username == $username) {
              $pass = TRUE;
            }
            elseif (!empty($commit->author->raw) && $commit->author->raw != $username) {
              foreach($raw_usernames as $raw_username) {
                if (strpos(strtolower($commit->author->raw), strtolower(trim($raw_username)))) {
                  $pass = TRUE;
                }
              }
            }
          }
          if ($pass == FALSE) {
            continue;
          }

          // Change in logic. If we run into a commit we already have, it stands to reason
          // that we have all the commits after this. No need to check the rest of the
          // repo. Go to the next repo. 3 loops back.
          $check = db_select('commits', 'c')
                    ->fields('c')
                    ->condition('cid', $cid)
                    ->execute();
          if ($check->rowCount() > 0) {
            break 2;
          }

          $files_changed = $lines_added = $lines_removed = 0;
          // We need to do this as opposed to in_array thanks to extra spaces that may
          // appear at the end of items in the textarea boxes.
          $lines = FALSE;
          foreach ($repos_line as $rline) {
            if (trim($rline) == $repo) {
              $lines = TRUE;
              break;
            }
          }
          if ($lines == TRUE && !empty($commit->links->patch->href)) {
            $patch = $commit->links->patch->href;
            $file = _bitbucket_commits_api_call($patch, $username, $password, FALSE, TRUE);
            $lines = explode("\n", $file);

            $parse_line = 0;
            foreach($lines as $key => $line) {
              if (strpos($line, 'changed')) {
                $parse_line = $key;
                break;
              }
            }
            if ($parse_line != 0) {
              $lines[$parse_line] = trim($lines[$parse_line]);
              $items = explode(', ', $lines[$parse_line]);

              $files = (!empty($items[0])) ? $items[0] : 0;
              $plus = (!empty($items[1])) ? $items[1] : 0;
              $minus = (!empty($items[2])) ? $items[2] : 0;

              if (!empty($files)) {
                $files = explode(' ', $files);
                $files_changed = (int) $files[0];
              }
              if (!empty($plus)) {
                $plus = explode(' ', $plus);
                $lines_added = (int) $plus[0];
              }
              if (!empty($minus)) {
                $minus = explode(' ', $minus);
                $lines_removed = (int) $minus[0];
              }
            }
          }

          // We need to make sure we do not have this commit logged before we try to put it in.
          $res = db_select('commits')->fields(NULL, array('cid'))->condition('cid', $cid)->countQuery()->execute()->fetchField();
          if ((int) $res < 1) {
            $centry = array(
              'cid' => $cid,
              'commit_message' => addslashes($message),
              'commit_date' => $commit->date,
              'project' => $project,
              'files_changed' => $files_changed,
              'lines_added' => $lines_added,
              'lines_removed' => $lines_removed,
              'repository' => 'bitbucket',
            );
            drupal_write_record('commits', $centry);

            $commits = db_select('commits_digest', 'cd')
                        ->fields('cd')
                        ->condition('cd.commit_date', $commit_date . ' 00:00:00')
                        ->execute();
            if ($commits->rowCount() > 0) {
              $commits_data = $commits->fetchObject();
              $commits_data->commits++;
              $centry = array(
                'commit_date' => $commit_date . " 00:00:00",
                'commits' => $commits_data->commits,
              );
              drupal_write_record('commits_digest', $centry, array('commit_date'));
            }
            else {
            $centry = array(
                'commit_date' => $commit_date . " 00:00:00",
                'commits' => 1,
                'repository' => 'bitbucket',
              );
              drupal_write_record('commits_digest', $centry);
            }
          }
        }
      }
      if (!empty($json->next)) {
        $url = $json->next;
      }
    } while(!empty($json->next));
  }
  // Save the information on our repositories to the database.
  if (count($repositories) > 0) {
    foreach  ($repositories as $repository) {
      try {
        $is_private = ($repository->is_private == 1) ? 1 : 0;
        db_merge('commits_projects')
          ->key(array('full_name' => $repository->full_name))
          ->fields(array(
            'full_name' => $repository->full_name,
            'name' => $repository->name,
            'is_private' => $is_private,
            'website' => $repository->website,
            'language' => $repository->language,
            'description' => $repository->description,
            'repository' => 'bitbucket'
            ))
          ->execute();
      }
      catch (Exception $e) {
        watchdog('bitbucket_commits', $e->getMessage(), array(), WATCHDOG_WARNING);
      }
    }
  }
}

/**
 * Retrieve all of the commits configured from bitbucket.
 */
function _bitbucket_commits_github_retrieve() {
  $repos = variable_get('bitbucket_github_repositories', FALSE);
  $repos_line = variable_get('bitbucket_github_repositories_line_numbers', FALSE);
  $username = variable_get('bitbucket_github_username', NULL);
  $password = variable_get('bitbucket_github_personal_access_token', NULL);

  if (!empty($repos_line)) {
    $repos_line = explode("\n", $repos_line);
  }

  if (empty($repos)) {
    return FALSE;
  }

  $repos = explode("\n", $repos);
  $repositories = array();
  foreach($repos as $repo) {
    $xx = 0;
    if (empty($repo)) {
      continue;
    }
    $repo = trim($repo);
    $url = 'https://api.github.com/repos/' . $repo . '/commits?author=' . $username;
    do {
      $json = _bitbucket_commits_api_call($url, $username, $password, TRUE, FALSE);
      if ($json == FALSE) {
        drupal_set_message('GitHub API rate limit exceeded. Repository: ' . $repo, 'error');
        db_query('DELETE FROM {commits} WHERE project = :project', array(':project' => $repo));
        drupal_goto('admin/config/development/bitbucket/display');
      }
      if (!empty($json->next)) {
        $next = $json->next;
        unset($json->next);
      }
      if (!empty($json->message) && substr($json->message,0,14) == 'API rate limit') {
        drupal_set_message('GitHub API rate limit exceeded. Repository: ' . $repo, 'error');
        db_query('DELETE FROM {commits} WHERE project = :project', array(':project' => $repo));
        break 2;
      }

      if (empty($json)) {
        drupal_set_message('No repository named ' . $repo . '.', 'error');
        break;
      }
      if (count($json) > 0) {
        foreach ($json as $commit) {
          if (!array_key_exists($repo, $repositories)) {
            $repository_information = bitbucket_commits_github_get_repository_information($repo, $username, $password);
            $repositories[$repository_information->full_name] = $repository_information;
          };

          if (empty($commit->sha)) {
            continue;
          }

          $cid = $commit->sha;
          $project = $repo;
          $message = $commit->commit->message;

          // Do timezone conversion of the date from BitBucket. All their times are in
          // UTC regardles of your timezone settings. Adjust this to Drupal's default
          // timezone for storage. Doing so here, enables our other time-sensitive
          // queries to work properly. 
          $commit->commit->committer->date = new DateTime($commit->commit->committer->date, new DateTimeZone('UTC'));
          $commit->commit->committer->date->setTimezone(new DateTimeZone('America/New_York'));
          $the_date = (array) $commit->commit->committer->date;

          list($commit_date, $commit_time) = explode(' ', $the_date['date']);
          list($commit_time) = explode('.', $commit_time);
          $commit->date = $commit_date . ' ' . $commit_time;
          
          // Change in logic. If we run into a commit we already have, it stands to reason
          // that we have all the commits after this. No need to check the rest of the 
          // repo. Go to the next repo. 3 loops back
          $check = db_select('commits', 'c')
                    ->fields('c')
                    ->condition('cid', $cid)
                    ->execute();
          if ($check->rowCount() > 0) {
            break 2;
          }

          $centry = array(
            'cid' => $cid,
            'commit_message' => addslashes($message),
            'commit_date' => $commit->date,
            'project' => $project,
            'files_changed' => 0,
            'lines_added' => 0,
            'lines_removed' => 0,
            'repository' => 'github',
          );

          drupal_write_record('commits', $centry);

          $commits = db_select('commits_digest', 'cd')
                      ->fields('cd')
                      ->condition('cd.commit_date', $commit_date . ' 00:00:00')
                      ->execute();
          if ($commits->rowCount() > 0) {
            $commits_data = $commits->fetchObject();
            $commits_data->commits++;
            $centry = array(
              'commit_date' => $commit_date . " 00:00:00",
              'commits' => $commits_data->commits,
            );
            drupal_write_record('commits_digest', $centry, array('commit_date'));
          }
          else {
           $centry = array(
              'commit_date' => $commit_date . " 00:00:00",
              'commits' => 1,
              'repository' => 'github',
            );
            drupal_write_record('commits_digest', $centry);
          }
        }
      } 
      if (!empty($next)) {
        $url = $next;
      }
    } while(!empty($next));
  }
  // Save the information on our repositories to the database.
  if (count($repositories) > 0) {
    foreach  ($repositories as $repository) {
      try {
        $is_private = ($repository->private == 1) ? 1 : 0;
        db_merge('commits_projects')
          ->key(array('full_name' => $repository->full_name))
          ->fields(array(
            'full_name' => $repository->full_name,
            'name' => $repository->name,
            'is_private' => $is_private,
            'website' => $repository->html_url,
            'language' => $repository->language,
            'description' => $repository->description,
            'repository' => 'github'
            ))
          ->execute();
      }
      catch (Exception $e) {
        watchdog('bitbucket_commits', $e->getMessage(), array(), WATCHDOG_WARNING);
      }
    }
  }
}

/**
 * Helper function to make API call to BitBucket (authenticated)
 *
 * @param string $url
 * The URL we are calling.
 *
 * @param string $username
 * The username for our authentication
 *
 * @param string $password
 * The password for the username provided.
 *
 * @return string $results
 * The JSON string from BitBucket to be parsed.
 */
function _bitbucket_commits_api_call($url, $username, $password, $decode = TRUE, $file = FALSE) {
  $ch = curl_init();
  curl_setopt($ch, CURLOPT_URL, $url);
  curl_setopt($ch, CURLOPT_TIMEOUT, 30);
  curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
  curl_setopt($ch, CURLOPT_VERBOSE, 1);
  curl_setopt($ch, CURLOPT_HEADER, 1);
  curl_setopt($ch, CURLOPT_HTTPAUTH, CURLAUTH_ANY);
  curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, FALSE);
  curl_setopt($ch, CURLOPT_COOKIEFILE, 'cookiefile.txt');
  curl_setopt($ch, CURLOPT_HTTPHEADER,
    array(
      "User-Agent: Commits Drupal Module",
      "Authorization: Basic " . base64_encode($username . ":" . $password)
    )
  );

  curl_setopt($ch, CURLOPT_USERPWD, "$username:$password");
  $status_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
  $response = curl_exec ($ch);

  // Then, after your curl_exec call:
  $header_size = curl_getinfo($ch, CURLINFO_HEADER_SIZE);
  $header = substr($response, 0, $header_size);
  $result = substr($response, $header_size);
  curl_close($ch);

  // Check for Bitbucket API rate limit.
  if ($result == 'Rate limit for this resource has been exceeded') {
    return FALSE;
  }

  // Check for GitHub API rate limit.
  $json = json_decode($result);
  if (!empty($json->message) && substr($json->message, 0, 14) == 'API rate limit') {
    return FALSE;
  }

  // If what we have is a file then we need to return the un-jsonized result.
  if ($file == TRUE) {
    return $result;
  }

  // This code is for getting paginated links from GitHub. Triggered by the function call and if
  // false then we just take the json decoded results and return them.
  if ($decode == TRUE) {
    $next = NULL;
    $headers = explode("\n", $header);
    foreach($headers as $line) {
      $params = explode(': ', $line);
      if ($params[0] == "Link" && !empty($params[1])) {
        for($i=0; $i<strlen($params[1]); $i++) {
          if (substr($params[1], $i, 1) == "<") {
            $start = $i + 1;
          }
          if (substr($params[1], $i, 1) == ">") {
            $end = $i - 1;
            break;
          }
        }
        $next = substr($params[1], $start, $end);
      }
    }
    $results = (object) json_decode($result);
    $results->next = $next;
  }
  else {
    $results = (object) json_decode($result);
  }

  return $results;
}

/**
 * Implements hook_theme().
 */
function bitbucket_commits_theme($existing, $type, $theme, $path) {
  return array(
    'bitbucket_commits_svg' => array(
      'template' => 'bitbucket-commits-svg',
      'variables' => array('width' => 721, 'height' => 110, 'class' => NULL, 'weeks' => NULL, 'offset_x' => 20, 'offset_y' => 20),
    ),
    'bitbucket_commits_svg_week' => array(
      'template' => 'bitbucket-commits-svg-week',
      'variables' => array('x' => 0, 'y' => 0, 'rects' => NULL),
    ),
    'bitbucket_commits_svg_rect' => array(
      'template' => 'bitbucket-commits-svg-rect',
      'variables' => array('class' => NULL, 'width' => 11, 'height' => 11, 'y' => 0, 'fill_color' => NULL, 'tooltip' => NULL),
    ),
    'bitbucket_commits_svg_month_header' => array(
      'template' => 'bitbucket-commits-svg-month-header',
      'variables' => array('x' => 0, 'y' => 0, 'class' => NULL, 'month' => NULL),
    ),
    'bitbucket_commits_lines_added' => array(
      'variables' => array('end_date' => NULL),
    ),
    'bitbucket_commits_lines_removed' => array(
      'variables' => array('end_date' => NULL),
    ),
    'bitbucket_commits_activity_graph' => array(
      'variables' => array('end_date' => NULL, 'color_scheme' => NULL, 'color1' => NULL, 'color2' => NULL, 'color3' => NULL, 'color4' => NULL),
    ),
    'bitbucket_commits_block' => array(
      'variables' => array('graph' => NULL, 'lines_added' => NULL, 'lines_removed' => NULL, 'commits' => NULL, 'max_streak' => NULL, 'current_streak' => NULL, 'total_commits' => NULL, 'line_stats' => NULL),
      'template' => 'bitbucket-commits-block',
    ),
  );
}

/**
 * Our one year graph comparable to the one provied by github.
 * We need to get the date of the first saturday beyond the end date provided and use that
 * as our end date.
 */ 
function bitbucket_commit_year_box_graph($end_date, $theme_color_scheme = NULL, $color1 = NULL, $color2 = NULL, $color3 = NULL, $color4 = NULL, $color5 = NULL) {

  // If the end date is not a Saturday, get the date until the next Saturday.
  if (date('l', strtotime($end_date)) != 'Saturday') {
    $end_date = date('Y-m-d', strtotime('next Saturday', strtotime($end_date)));
  }

  $end_date_time = strtotime($end_date);
  $start_date = date('Y-m-d', $end_date_time - (86400*364));
  $start_date = date('Y-m-d', strtotime('previous Sunday', strtotime($start_date)));
  $start_date_time = strtotime($start_date);
  $graph = array();
  for ($i = $start_date_time; $i <= $end_date_time; $i += 86400) {
    $current_date = date('Y-m-d', $i);
    $graph[$current_date] = array(
      'commits' => array(
        'bitbucket' => 0,
        'github' => 0,
      ),
      'date' => date('m/d/Y', $i),
    );
  }

	$result = db_query("SELECT SUBSTR(commit_date, 1, 10) AS commit_date, count(cid) AS commits, repository
	                    FROM {commits}
	                    WHERE commit_date >= DATE_SUB('" . $end_date . "', INTERVAL 364 DAY)
	                    GROUP BY substr(commit_date, 1, 10), repository
	                    ORDER BY commit_date ASC, repository ASC");   
  while ($ddata = $result->fetchObject()) {
    $graph[$ddata->commit_date]['commits'][$ddata->repository] = $ddata->commits;
  }

  // Sort the graph by date, which is in the key.
  ksort($graph);

  $y = $position = 0;
  $rects = $weeks = $year_graph = $current_month = NULL;
  $month_header = array();

  // Matrix of our standard colors.
  $color['grey'] = array('#EAEAEA', '#C0C0C0', '#A0A0A0', '#606060', '#202020');
  $color['red'] = array('#EAEAEA', '#FFC0C0', '#FF9090', '#FF6060', '#FF2020');
  $color['green'] = array('#EAEAEA', '#C0D0C0', '#A0D0A0', '#60D060', '#20D020');
  $color['blue'] = array('#EAEAEA', '#C0C0FF', '#A0A0FF', '#6060FF', '#2020FF');
  $color['yellow'] = array('#EAEAEA', '#DDDD20', '#CCCC20', '#BBBB20', '#AAAA20');
  $color['orange'] = array('#EAEAEA', '#fce2b4', '#fbd38e', '#fcc35f', '#feae22');
  $color['brown'] = array('#EAEAEA', '#d2bc97', '#be9d63', '#a58246', '#9d6400');
  $color['purple'] = array('#EAEAEA', '#fcd5f7', '#fca8f1', '#fd68ea', '#fd2de2');
  $color['pink'] = array('#EAEAEA', '#ffd7eb', '#febcdd', '#fc8ec5', '#FF69B4');
  $color['github'] = array('#EAEAEA', '#cde372', '#7bbd52', '#389631', '#1a571b');

  // If the custom color is provided in our UI, then assign the colors to our color
  // scheme for processing.
  $color['bitbucket_custom'] = array(
    variable_get('bitbucket_activity_custom_color1', NULL),
    variable_get('bitbucket_activity_custom_color2', NULL),
    variable_get('bitbucket_activity_custom_color3', NULL),
    variable_get('bitbucket_activity_custom_color4', NULL),
    variable_get('bitbucket_activity_custom_color5', NULL),
  );
  $color['github_custom'] = array(
    variable_get('bitbucket_github_activity_custom_color1', NULL),
    variable_get('bitbucket_github_activity_custom_color2', NULL),
    variable_get('bitbucket_github_activity_custom_color3', NULL),
    variable_get('bitbucket_github_activity_custom_color4', NULL),
    variable_get('bitbucket_github_activity_custom_color5', NULL),
  );

  $cdate = array();
  $ccolor = array();
  foreach ($graph as $date => $data) {
    if (date('l', strtotime($date)) == 'Sunday') {
      if ($position > 0) {
        $weeks .= theme('bitbucket_commits_svg_week',  array('x' => (13 * ($position - 1)), 'y' => 0, 'rects' => $rects));
        $rects = NULL;
      }
      if (date('M', strtotime($date)) != $current_month) {
        $current_month = date('M', strtotime($date));
        $month_header[] = array(
          'month' => $current_month,
          'x' => 13 * $position,
        );
      }
      $y = 0;
      $x = 11 * $position;
      $position++;
    }

    $bitbucket_color = variable_get('bitbucket_activity_color_scheme', 'green');
    $github_color = variable_get('bitbucket_github_activity_color_scheme', 'green');

    $total_commits = 0;
    foreach (array('bitbucket', 'github') as $repository) {
      $color_scheme = ($repository == 'bitbucket') ? $bitbucket_color : $github_color;
      if ($color_scheme == 'custom') {
        if ($repository == 'bitbucket') {
          $color_scheme = 'bitbucket_custom';
        }
        else {
          $color_scheme = 'github_custom';
        }
      }

      if (!empty($data['commits'][$repository])) {
        $total_commits += $data['commits'][$repository];
      }
      
      // If we are being passed a custom color scheme via the theme function, then we have
      // to assign our colors as follows.
      if (!empty($theme_color_scheme)) {
        $color_scheme = 'theme';
        $color['theme'] = array($color1, $color2, $color3, $color4, $color5);
      }

      if (!empty($data['commits'][$repository])) {
        if ($data['commits'][$repository] == 0) {
          $fill_color = $color[$color_scheme][0];
        }
        elseif ($data['commits'][$repository] < 4) {
          $fill_color = $color[$color_scheme][1];
        }
        elseif ($data['commits'][$repository] < 7) {
          $fill_color = $color[$color_scheme][2];
        }
        elseif ($data['commits'][$repository] < 10) {
          $fill_color = $color[$color_scheme][3];
        }
        else {
          $fill_color = $color[$color_scheme][4];
        }
      }
      else {
        $fill_color = $color[$color_scheme][0];
      }
      $tooltip = NULL;
      $y = 13 * date('w', strtotime($date));

      if (!empty($ccolor[$date])) {
        $fill_color = bitbucket_commits_mix_colors($ccolor[$date], $fill_color, $base_color_zero, $color[$color_scheme][0]);
      }
      else {
        $base_color_zero = $color[$color_scheme][0];
      }

      $ccolor[$date] = $fill_color;
    }
    $tooltip = $total_commits . ' Commits on ' . date('m/d/Y', strtotime($date));
    $rects .= theme('bitbucket_commits_svg_rect', array(
      'class' => 'day', 'width' => 11, 'height' => 11, 'y' => $y, 
      'fill_color' => $fill_color, 'tooltip' => $tooltip));
  }

  // To prevent months from overlapping. If the two months are within two rows of each
  // other, then the first one will be deleted.
  if (($month_header[0]['x']+26) == $month_header[1]['x']) {
      array_shift($month_header);
  }

  // Output the last row since it is not tripped by the date catch at the beginning of
  // the loop on the last iteration.
  $weeks .= theme('bitbucket_commits_svg_week',  array('x' => (13 * ($position - 1)), 'y' => 0, 'rects' => $rects));

  $mh = NULL;
  foreach($month_header as $month) {
    $mh .= theme('bitbucket_commits_svg_month_header', array('x' => $month['x'], 'y' => -5, 'class' => 'month' , 'month' => $month['month']));
  }

  return theme('bitbucket_commits_svg', array('width' => 721, 'height' => 110, 'class' => NULL, 'weeks' => $weeks, 'month_header' => $mh, 'offset_x' => 20, 'offset_y' => 20));
}

/**
 * Theme function for generating activity graph.
 *
 * @param string $end_date
 * The ending date for which data should be collected. Rounds to the next Saturday.
 *
 * @return string $html
 * The HTML of the rendered graph.
 */
function theme_bitbucket_commits_activity_graph($data = NULL) {
  if (empty($data['end_date'])) {
    $end_date = date('Y-m-d');
  }
  else {
    $end_date = date('Y-m-d', strtotime($data['end_date']));
  }
  return bitbucket_commit_year_box_graph($end_date);
}

/**
 * Theme function for getting the number of commit lines added.
 *
 * @param string $end_date
 * The ending date for which data should be collected. Rounds to the next Saturday.
 *
 * @return int $lines
 * The number of lines added.
 */
function theme_bitbucket_commits_lines_added($data = NULL) {
  if (empty($data['end_date'])) {
    $end_date = date('Y-m-d H:i:s');
  }
  else {
    $end_date = date('Y-m-d H:i:s', strtotime($data['end_date']));
  }
  $result = db_query("SELECT SUM(lines_added) AS lines_added FROM {commits} WHERE commit_date <= '" . $end_date . "'");
  $lines = $result->fetchObject();
  return $lines->lines_added;
}

/**
 * Theme function for getting the number of commit lines removed.
 *
 * @param string $end_date
 * The ending date for which data should be collected. Rounds to the next Saturday.
 *
 * @return int $lines
 * The number of lines removed.
 */
function theme_bitbucket_commits_lines_removed($data = NULL) {
  if (empty($data['end_date'])) {
    $end_date = date('Y-m-d H:i:s');
  }
  else {
    $end_date = date('Y-m-d H:i:s', strtotime($data['end_date']));
  }

  $result = db_query("SELECT SUM(lines_removed) AS lines_removed FROM {commits} WHERE commit_date <= '" . $end_date . "'");
  $lines = $result->fetchObject();
  return $lines->lines_removed;
}

/**
 * Get the commits per project within the given interval of a given date.
 *
 * @param int $interval
 * The interval within the given date (in days). Defaults to 14.
 *
 * @param string $date
 * The date to be used around the interval. Defaults to the current date.
 *
 * @return array $commits
 * An array of the commit counts and projects sorted in reverse order by commit count.
 */
function bitbucket_commits_project_commit_interval_count($interval = 14, $date = NULL, $is_private = TRUE) {
  if (empty($date)) {
    $date = date('Y-m-d');
  }
  if (empty($is_private)) {
    $is_private = 0;
  }

  // Get the list of items we do not wish to display in the list.
  $do_not_display = variable_get('bitbucket_do_not_display');
  $do_not_display = str_replace("\r", "", $do_not_display); // Windows :(
  $do_not_display = (!empty($do_not_display)) ? explode("\n", $do_not_display) : array();

  $result = db_query("SELECT COUNT(*) as commit_count, project, repository
                      FROM {commits}
                      WHERE commit_date >= DATE_SUB('" . $date . "', INTERVAL " . $interval . " DAY)
                      GROUP by project ORDER BY commit_count DESC");
  $commits = array();
  if ($result->rowCount() > 0) {
    while($cdata = $result->fetchObject()) {
      // If we're in the do not display array, then pass it by.
      if (in_array($cdata->project, $do_not_display)) {
        continue;
      }
      $private = db_query('SELECT * FROM {commits_projects} 
                           WHERE full_name = :full_name', array(':full_name' => $cdata->project));
      if ($private->rowCount() > 0) {
        $pdata = $private->fetchObject();
      }
      if (empty($is_private) && $pdata->is_private == 1) {
        continue;
      }
      $commits[] = array(
        'project' => $pdata->full_name,
        'commits' => $cdata->commit_count,
        'description' => $pdata->description,
        'website' => $pdata->website,
        'language' => $pdata->language,
        'is_private' => $pdata->is_private,
        'repository' => $pdata->repository,
      );
    }
  }
  return $commits;
}

/**
 * Get repository information for a specific repo (API Call)
 *
 * @param string $repo
 * The repository we are getting information on
 *
 * @param string $username
 * The username for our authentication
 *
 * @param string $password
 * The password for the username provided.
 *
 * @return string $results
 * The JSON decoded array from BitBucket to be parsed.
*/
function bitbucket_commits_get_repository_information($repo, $username, $password) {
  $url = 'https://api.bitbucket.org/2.0/repositories/' . $repo;
  $result = _bitbucket_commits_api_call($url, $username, $password);
  return $result;
}

/**
 * Get GitHub repository information for a specific repo (API Call)
 *
 * @param string $repo
 * The repository we are getting information on
 *
 * @param string $username
 * The username for our authentication
 *
 * @param string $password
 * The password for the username provided.
 *
 * @return string $results
 * The JSON decoded array from BitBucket to be parsed.
*/
function bitbucket_commits_github_get_repository_information($repo, $username, $password) {
  $url = 'https://api.github.com/repos/' . $repo;
  $result = _bitbucket_commits_api_call($url, $username, $password);
  return $result;
}

/**
 * Implements hook_help().
 */
function bitbucket_commits_help($path, $arg) {
  $output = NULL;
  switch($path) {
    case 'admin/help#bitbucket_commits':
      $output .= '<h4>' . t('Bitbucket & GitHun Commits Overview') . '</h4>';
      $output .= 'Wiki Documentation: <a href="https://bitbucket.org/mrbagnall/bitbucket_commits/wiki/Home">https://bitbucket.org/mrbagnall/bitbucket_commits/wiki/Home</a><br /><br />';
      $output .= t('This is the documentation wiki for the BitBucket Commits module for Drupal. It contains the information and instructions you will need to get up and running using this module. The contents of this wiki are also contained in the advanced help section of the module available if you have the Advanced Help contributed module installed on your installation of Drupal.') . '<br /><br />';
      $output .= '<h4>' . t('Features') . "</h4>";
      $output .= t('The purpose of this module is to provide a GitHub style activity graph to for your BitBucket git repository. It can provide statistics on public and/or private repositories and can also provide additional statistics such as numbers of lines committed and removed from repositories. Over time, these reports and statistics will become more granular so they can be used in a variety of ways on your Drupal Site.') . '<br /><br />';
      $output .= t('The main target for this module are developers who wish to report their activity on a web site such as a personal web site or blog. At some point, it may become possible to include the graph via a javascript "bug" on a target web site, but that functionality is planned down the road.') . '<br /><br />';
      $output .= '<div style="border-top: 2px solid #f8981d; margin: 15px 0px; padding-top: 15px; width: 100%; font-size: 8pt; line-height: 1.3em;">';
      $output .= '<img src="/' . drupal_get_path('module', 'bitbucket_commits') . '/images/flyingflip-logo.png" width="151" height="50" alt="FlyingFlip Studios" align="right" /><br />';
      $output .= 'Released 2016-2017 - v7.x-1.x - FlyingFlip Studios, LLC. - Released under GNU GENERAL PUBLIC LICENSE - Version 2, June 1991<br />http://www.michaelbagnall.com - @flyingflip - @mbagnall17<br clear="right">';
      $output .= '<style>.item-list, hr { display: none; }</style></div>';      
      break;
  }
  return $output;
}

/**
 * Implements hook_block_info().
 */
function bitbucket_commits_block_info() {
  $blocks = array();
  $blocks['bitbucket'] = array(
    'info' => t('BitBucket Statistics'),
    'cache' => DRUPAL_NO_CACHE,
  );
  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function bitbucket_commits_block_view($delta = '') {
  $block = array();
  switch ($delta) {
    case 'bitbucket':
      $block['subject'] = t('BitBucket Statistics');
      $block['content'] = array(
        '#markup' => bitbucket_commits_block_html(),
        '#attached' => array(
          'css' => array(
            drupal_get_path('module', 'bitbucket_commits') . '/css/style.css',
          ),
        ),
      );
      break;
  }
  return $block;
}

/**
 * Implements hook_block_configure().
 */
function bitbucket_commits_block_configure($delta = '') {
  $form = array();
  if ($delta == 'bitbucket') {
    $form['bitbucket_commits'] = array(
      '#type' => 'fieldset',
      '#title' => 'BitBucket Settings',
    );
    $form['bitbucket_commits']['bitbucket_commits_recent_commits_repo_days'] = array(
      '#type' => 'textfield',
      '#title' => 'Display commit repo details for how many days?',
      '#description' => t('Setting this to 0 will disable the functionality, otherwise set to the commit activity statistics for an interval of this many days.'),
      '#default_value' => variable_get('bitbucket_commits_recent_commits_repo_days', 14),
      '#required' => TRUE,
      '#maxlength' => 3,
      '#size' => 3,
      '#weight' => 9,
    );
    $form['bitbucket_commits']['bitbucket_commits_recent_commits_repo_days_private'] = array(
      '#type' => 'checkbox',
      '#title' => 'Include private repositories in the recent commits option above?',
      '#options' => array(
        '1' => t('Yes'),
        '0' => t('No'),
      ),
      '#default_value' => variable_get('bitbucket_commits_recent_commits_repo_days_private', 1),
      '#weight' => 10,
    );
    $form['bitbucket_commits']['bitbucket_commits_display_line_stats'] = array(
      '#type' => 'checkbox',
      '#title' => 'Display per line statistics in block?',
      '#options' => array(
        '1' => t('Yes'),
        '0' => t('No'),
      ),
      '#default_value' => variable_get('bitbucket_commits_display_line_stats', 0),
      '#weight' => 11,
    );
  }
  return $form;
}

/**
 * Implements hook_block_save().
 */
function bitbucket_commits_block_save($delta, $edit) {
  variable_set('bitbucket_commits_recent_commits_repo_days', $edit['bitbucket_commits_recent_commits_repo_days']);
  variable_set('bitbucket_commits_recent_commits_repo_days_private', $edit['bitbucket_commits_recent_commits_repo_days_private']);
  variable_set('bitbucket_commits_display_line_stats', $edit['bitbucket_commits_display_line_stats']);
}

/**
 * Output the HTML for our block.
 */
function bitbucket_commits_block_html() {
  $repo_days = variable_get('bitbucket_commits_recent_commits_repo_days', 0);
  $private = variable_get('bitbucket_commits_recent_commits_repo_days_private', 1);
  $line_stats = variable_get('bitbucket_commits_display_line_stats', 0);
  $max_streak = bitbucket_commits_sequential_streak();
  $current_streak = bitbucket_commits_current_streak();
  $total_commits = bitbucket_commits_total_commits();

  $commits = array();
  $lines_added = $lines_removed = NULL;
  $graph = bitbucket_commit_year_box_graph(date('Y-m-d'));
  if (!empty($repo_days)) {
    $commits = bitbucket_commits_project_commit_interval_count($repo_days, date('Y-m-d'), $private);
  }
  if (!empty($line_stats)) {
    $lines_added = theme('bitbucket_commits_lines_added');
    $lines_removed = theme('bitbucket_commits_lines_removed');
  }
  $graph =  theme('bitbucket_commits_block', 
    array('graph' => $graph, 'commits' => $commits, 'line_stats' => $line_stats, 'lines_added' => $lines_added, 
          'lines_removed' => $lines_removed, 'max_streak' => $max_streak, 
          'current_streak' => $current_streak, 'total_commits' => $total_commits));
  return $graph;
}

/**
 * Get the most sequential streak for this configuration.
 */
function bitbucket_commits_sequential_streak() {
  $end_date = $today = date('Y-m-d');
  $yesterday =  date('Y-m-d', strtotime('yesterday', time()));
  $result = db_select('commits_digest', 'c')
            ->fields('c')
            ->where("commit_date >= DATE_SUB('" . $end_date . "', INTERVAL 364 DAY)")
            ->condition('commit_date', $end_date, '<=')
            ->orderBy('commit_date', 'DESC')
            ->execute();       
  $sequential = $max_sequential = 0;
  while($ddata = $result->fetchObject()) {
    list($commit_date, $x) = explode(' ', $ddata->commit_date);
    if ($commit_date == $yesterday || $commit_date == $today) {
      $sequential++;
    }
    else {
      if ($sequential > $max_sequential) {
        $max_sequential = $sequential;
      }
      $sequential = 0;
    }
    $yesterday = date('Y-m-d', strtotime('yesterday', strtotime($commit_date)));
  }
  return $max_sequential;
}

/**
 * Get the current sequential streak for this configuration.
 */
function bitbucket_commits_current_streak() {
  $end_date = $today = date('Y-m-d');
  $yesterday =  date('Y-m-d', strtotime('yesterday', time()));
  $sequential = $max_sequential = 0;
  $result = db_select('commits_digest', 'c')
            ->fields('c')
            ->where("commit_date >= DATE_SUB('" . $end_date . "', INTERVAL 364 DAY)")
            ->condition('commit_date', $end_date, '<=')
            ->orderBy('commit_date', 'DESC')
            ->execute();
  while($ddata = $result->fetchObject()) {
    list($commit_date, $x) = explode(' ', $ddata->commit_date);
    if ($commit_date == $yesterday || $commit_date == $today) {
      $sequential++;
    }
    else {
      $max_sequential = $sequential;
      break;
    }
    $yesterday = date('Y-m-d', strtotime('yesterday', strtotime($commit_date)));
  }
  return $max_sequential;
}

/**
 * Get the total number of commits for the last year.
 */
function bitbucket_commits_total_commits() {
  $end_date = $yesterday = date('Y-m-d');
  $result = db_query("SELECT SUM(commits) AS commits 
                      FROM {commits_digest} 
                      WHERE commit_date >= DATE_SUB('" . $end_date . "', INTERVAL 364 DAY)");
  $lines = $result->fetchObject();
  return $lines->commits;
}

/**
 * Clear out all Bitbucket & GitHub statistics
 */
function bitbucket_commits_clear() {
	db_query('TRUNCATE TABLE {commits}');
	db_query('TRUNCATE TABLE {commits_digest}');
	drupal_set_message('All Bitbucket & GitHub statistics cleared.', 'status');
	drupal_goto('admin/config/development/bitbucket/display');
}

/**
 * If we have commits for Bitbucket and Github on the same day, create a gradiant based
 * on which one has more commits.
 *
 * @param string $color1
 * The first color to mix.
 *
 * @param string $color2
 * The second color to mix.
 *
 * @param string $base1
 * The base color (zero commit color) for the first mix color scheme.
 *
 * @param string $color1
 * The base color (zero commit color) for the second mix color scheme.
 *
 * @return string $color
 * The resulting color mix.
 */
function bitbucket_commits_mix_colors($color1, $color2, $base1, $base2) {
  // If one of our colors is the same as the base color, then just return the other color.
  // Prevents mixing with the zero-commit color.
  if ($color1 == $base1) {
    return $color2;
  }
  if ($color2 == $base2) {
    return $color1;
  }

  $color1 = array(
    substr($color1, 1, 2),
    substr($color1, 3, 2),
    substr($color1, 5, 2),
  );
  $color2 = array(
    substr($color2, 1, 2),
    substr($color2, 3, 2),
    substr($color2, 5, 2),
  );

  for ($i=0; $i<=2; $i++) {
    $c1 = hexdec($color1[$i]);
    $c2 = hexdec($color2[$i]);
    $add = ($c1 + $c2) / 2;
    $color3[$i] = dechex($add);
  }
  return '#' . join('', $color3);
}
